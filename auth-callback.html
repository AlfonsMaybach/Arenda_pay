<!DOCTYPE html>
<html>
<head>
  <title>Обработка авторизации</title>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const authCode = urlParams.get('code');
      
      console.log('Auth callback received. Code:', authCode);
      console.log('Full URL:', window.location.href);


      if (authCode) {
        // Данные для ПЕСОЧНИЦЫ Точки
        const CLIENT_ID = 'sandbox_client';
        const CLIENT_SECRET = 'sandbox_secret';
        const REDIRECT_URI = 'https://alfonsmaybach.github.io/Arenda_payment/auth-callback.html';
        
        const tokenEndpoint = 'https://enter-sandbox.tochka.com/uapi/oauth2/token';
        const requestBody = new URLSearchParams({
          grant_type: 'authorization_code',
          code: authCode,
          client_id: CLIENT_ID,
          client_secret: CLIENT_SECRET,
          redirect_uri: REDIRECT_URI
        });
        
        console.log('Request to token endpoint:', tokenEndpoint);
        console.log('Request body:', requestBody.toString());


        fetch(tokenEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: requestBody
        })
        .then(response => {
          console.log('Token response status:', response.status);
          
          if (!response.ok) {
            return response.text().then(text => {
              throw new Error(`HTTP ${response.status}: ${text}`);
            });
          }
          return response.json();
        })
        .then(data => {
          console.log('Token response data:', data);
          
          if (data.access_token) {
            localStorage.setItem('tochka_token', data.access_token);
            window.location.href = 'index.html?auth=success';
          } else {
            throw new Error('Токен не получен в ответе');
          }
        })
        .catch(error => {
          console.error('Auth error:', error);
          alert('Ошибка авторизации: ' + error.message);
        });
      } else {
        console.error('Authorization code not found in URL');
        alert('Код авторизации не найден. Пожалуйста, попробуйте снова.');
      }
    });
  </script>
</head>
<body>
  <p>Идёт авторизация...</p>
  <p id="status">Обработка запроса</p>
  <script>
    // Обновляем статус для пользователя
    document.getElementById('status').textContent = 
      'Получен код авторизации. Идет получение токена...';
  </script>
</body>
</html>